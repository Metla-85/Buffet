<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Menú Semanal Editable</title>
<link href="https://unpkg.com/tabulator-tables@5.5.0/dist/css/tabulator.min.css" rel="stylesheet">
<style>
body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; margin: 30px; background: #f8f9fa; }
h2 { text-align: center; margin-bottom: 20px; color: #343a40; }
.filters { display: flex; justify-content: center; gap: 20px; margin-bottom: 20px; }
.filters select, .filters button { padding: 6px 10px; border-radius: 6px; border: 1px solid #ccc; font-size: 0.95em; }
#tabla-menu { margin: 0 auto; max-width: 1000px; }
.tabulator-tableHolder { max-height: none !important; }
.tabulator-cell { display: flex; flex-direction: column; gap: 3px; align-items: stretch; padding: 5px; background-color: #fff; border-radius: 6px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); word-wrap: break-word; }
.plato-row { display: flex; justify-content: space-between; align-items: center; background-color: #007bff; color: #fff; padding: 3px 6px; border-radius: 6px; font-size: 0.9em; }
.plato-row button { background: transparent; border: none; color: white; font-weight: bold; cursor: pointer; }
.estacion-delete { margin-left: 10px; background:#dc3545; border:none; color:white; border-radius:4px; cursor:pointer; font-size:0.8em; padding:0 4px; }
#buscadorPlatos { padding: 20px; border-radius: 10px; border: 1px solid #ccc; width: 300px; }
#buscadorPlatos input { width: 100%; padding: 6px; margin-bottom: 10px; border-radius: 4px; border: 1px solid #ccc; }
#listaResultados { list-style: none; padding: 0; max-height: 150px; overflow-y: auto; border: 1px solid #ccc; border-radius: 4px; }
#listaResultados li { padding: 6px; cursor: pointer; }
#listaResultados li:hover { background-color: #007bff; color: white; }
#cerrarBuscador { margin-top: 10px; padding: 6px 12px; background-color: #dc3545; color: white; border: none; border-radius: 4px; cursor: pointer; }
</style>
</head>
<body>
<h2>Menú Semanal Editable</h2>

<div class="filters">
  <select id="hotelSelect">
    <option value="">Seleccione Hotel</option>
    <option value="Hotel1">Hotel1</option>
    <option value="Hotel2">Hotel2</option>
  </select>

  <select id="ruedaSelect">
    <option value="">Seleccione Rueda de Menú</option>
    <option value="2026_desayuno">2026_desayuno</option>
    <option value="2026_almuerzo">2026_almuerzo</option>
    <option value="2026_cena">2026_cena</option>
  </select>

  <button id="addEstacion">Añadir Estación</button>
</div>

<div id="tabla-menu"></div>

<dialog id="buscadorPlatos">
  <input id="inputBusqueda" placeholder="Buscar plato...">
  <ul id="listaResultados"></ul>
  <button id="cerrarBuscador">Cancelar</button>
</dialog>

<script src="https://unpkg.com/tabulator-tables@5.5.0/dist/js/tabulator.min.js"></script>
<script>
const dias = ["L","M","X","J","V","S","D"];
let estaciones = ["Frío","Caliente","Postres"];
const platosDisponibles = ["Patatas fritas","Arroz con pollo","Ensalada mixta","Macarrones","Sopa de verduras","Pescado al horno","Helado","Flan","Tarta"];
let datosActuales=[];
let celdaEditando=null;

function generarDatosVacios() {
    return estaciones.map(est=>{
        const row={estacion: est};
        dias.forEach(d=>row[d]=[]);
        return row;
    });
}

function cargarRuedaMenu() {
    const hotel=document.getElementById("hotelSelect").value;
    const rueda=document.getElementById("ruedaSelect").value;
    if(!hotel||!rueda) return;
    datosActuales=generarDatosVacios();
    if(hotel==="Hotel1" && rueda==="2026_desayuno"){
        datosActuales[0]["L"].push("Patatas fritas");
        datosActuales[1]["M"].push("Sopa de verduras");
    }
    tabla.replaceData(datosActuales);
}

function renderPlatos(cell){
    const container=document.createElement("div");
    container.style.display="flex";
    container.style.flexDirection="column";
    container.style.gap="3px";
    cell.getValue().forEach((plato)=>{
        const row=document.createElement("div");
        row.className="plato-row";
        row.innerHTML=`${plato} <button>&times;</button>`;
        row.querySelector("button").addEventListener("click",(e)=>{
            e.stopPropagation();
            if(confirm(`¿Eliminar el plato "${plato}"?`)){
                const valor=cell.getValue().filter(p=>p!==plato);
                cell.setValue(valor);
                cell.getRow().reformat();
                tabla.redraw(true);
            }
        });
        container.appendChild(row);
    });
    return container;
}

const tabla=new Tabulator("#tabla-menu",{
    data: generarDatosVacios(),
    layout:"fitColumns",
    columns:[
        {title:"Estación", field:"estacion", width:120, formatter:function(cell){
            const container=document.createElement("div");
            container.style.display="flex"; container.style.alignItems="center";
            container.textContent=cell.getValue();
            const btn=document.createElement("button");
            btn.className="estacion-delete";
            btn.textContent="X";
            btn.addEventListener("click", ()=>{
                if(confirm(`¿Eliminar la estación "${cell.getValue()}"?`)){
                    tabla.deleteRow(cell.getRow());
                    estaciones=estaciones.filter(e=>e!==cell.getValue());
                }
            });
            container.appendChild(btn);
            return container;
        }},
        ...dias.map(d=>({
            title:d,
            field:d,
            formatter:renderPlatos,
            cellClick:(e,cell)=>{celdaEditando=cell; mostrarBuscador(cell);}
        }))
    ],
});

const dialogo=document.getElementById("buscadorPlatos");
const lista=document.getElementById("listaResultados");
const inputBusqueda=document.getElementById("inputBusqueda");
const cerrarBtn=document.getElementById("cerrarBuscador");

function mostrarBuscador(cell){ inputBusqueda.value=""; filtrarResultados(""); dialogo.showModal(); inputBusqueda.focus(); }
function filtrarResultados(texto){ lista.innerHTML=platosDisponibles.filter(p=>p.toLowerCase().includes(texto.toLowerCase())).map(p=>`<li data-plato="${p}">${p}</li>`).join("") || "<li>(sin resultados)</li>"; }

inputBusqueda.addEventListener("input",e=>filtrarResultados(e.target.value));
lista.addEventListener("click",e=>{
    const plato=e.target.dataset.plato;
    if(!plato) return;
    const valor=celdaEditando.getValue();
    if(!valor.includes(plato)) valor.push(plato);
    celdaEditando.setValue(valor);
    celdaEditando.getRow().reformat();
    tabla.redraw(true);
    dialogo.close();
});
cerrarBtn.addEventListener("click",()=>dialogo.close());

document.getElementById("hotelSelect").addEventListener("change",cargarRuedaMenu);
document.getElementById("ruedaSelect").addEventListener("change",cargarRuedaMenu);

document.getElementById("addEstacion").addEventListener("click",()=>{
    const nombre=prompt("Nombre de la nueva estación:");
    if(!nombre) return;
    estaciones.push(nombre);
    const nuevaFila={estacion:nombre};
    dias.forEach(d=>nuevaFila[d]=[]);
    tabla.addRow(nuevaFila);
});
</script>
</body>
</html>
