<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<title>Rueda de Menú — App</title>
<link href="https://unpkg.com/tabulator-tables@5.5.0/dist/css/tabulator.min.css" rel="stylesheet">
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
<style>
  :root{
    --bg:#f3f6fb;
    --card:#ffffff;
    --primary:#2563eb;
    --primary-600:#1d4ed8;
    --accent:#10b981;
    --danger:#ef4444;
    --muted:#6b7280;
    --cell-min-height:64px;
    --radius:10px;
  }
  *{box-sizing:border-box}
  body{margin:0;font-family:Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;background:linear-gradient(180deg,#eef4ff 0%,var(--bg) 100%);color:#0f172a;padding:28px;}
  header.app-header{display:flex;gap:20px;align-items:center;justify-content:space-between;margin-bottom:18px;}
  .branding{ display:flex; gap:12px; align-items:center; }
  .logo{ width:48px;height:48px;border-radius:10px;background:linear-gradient(135deg,var(--primary),var(--primary-600)); display:flex;align-items:center;justify-content:center;color:#fff;font-weight:700;font-size:18px;box-shadow:0 6px 18px rgba(37,99,235,0.18); }
  h1{font-size:20px;margin:0;color:#062244}
  p.lead{margin:0;color:var(--muted);font-size:13px}
  .controls{ display:flex; gap:12px; align-items:center; }
  .select, .btn {
    background:var(--card);
    border:1px solid rgba(15,23,42,0.06);
    padding:8px 10px;border-radius:8px;font-size:14px;
    box-shadow:0 2px 6px rgba(12,20,40,0.04);
  }
  .select select{border:0;background:transparent;font-size:14px}
  .btn { display:inline-flex;align-items:center;gap:8px;border:none;background:var(--primary);color:#fff;padding:8px 12px;font-weight:600;border-radius:8px; cursor:pointer; }
  .btn.ghost{ background:transparent;color:var(--primary);border:1px solid rgba(37,99,235,0.12) }
  #tabla { flex:1;border-radius:var(--radius);overflow:hidden;background:var(--card);box-shadow:0 8px 30px rgba(8,24,48,0.06);padding:12px; }
  .tabulator-header { background: linear-gradient(90deg,var(--primary),var(--primary-600)); color:#fff; font-weight:600; }
  .tabulator-col { color:#fff; }
  .tabulator-tableHolder { max-height:none !important; }
  .tabulator-row { transition:background .12s ease,transform .08s ease; }
  .tabulator-row:hover{ transform: translateY(-2px); box-shadow:0 6px 20px rgba(13,24,58,0.06) }
  .handle-cell { display:flex;align-items:center;gap:8px;padding:8px 10px;font-weight:600;background:linear-gradient(180deg,#fff,#fbfdff);border-radius:8px; }
  .handle-icon{ display:inline-flex;width:30px;height:30px;border-radius:8px;background:linear-gradient(180deg,#eef2ff,#dbeafe);align-items:center;justify-content:center;color:var(--primary);font-weight:700; cursor:grab;border:1px solid rgba(15,23,42,0.04);}
  .tabulator-cell{ padding:10px; vertical-align:top; background:transparent; }
  .cell-inner{ position:relative; padding:8px; border-radius:8px; background:linear-gradient(180deg,#ffffff,#fbfdff); box-shadow:0 1px 2px rgba(12,20,40,0.03); transition:all .2s ease;}
  .cell-inner.empty{ opacity:0.9; display:flex; align-items:flex-start; justify-content:flex-start; min-height:calc(var(--cell-min-height)*1.2); }
  .plato-row{ display:flex;align-items:center;gap:8px;padding:6px 8px;border-radius:8px;background:linear-gradient(180deg,#fff,#f8fafc);border:1px solid rgba(9,30,66,0.04); font-size:13px;color:#082135; margin-bottom:6px;}
  .plato-row .remove { margin-left:auto;background:var(--danger);color:#fff;border-radius:6px;padding:6px 8px;font-weight:600;border:none;cursor:pointer;font-size:12px; }
  .plato-row .remove:hover{ background:#c0262e; }
  .add-plato{ position:absolute;right:8px;bottom:8px; z-index:60; width:32px;height:32px;border-radius:999px;border:none;background:var(--accent);color:#fff;font-weight:700; box-shadow:0 8px 20px rgba(16,185,129,0.12); cursor:pointer; display:flex;align-items:center;justify-content:center; }
  .add-plato:hover{ transform:translateY(-2px); background:#0ea36b; }
  .cell-select { position:absolute;left:8px;top:8px; z-index:50; width:18px;height:18px; }
  .plato-row input[type="checkbox"]{ margin-right:6px; accent-color:var(--primary);}
  #copiarPlatos, #pegarPlatos, #addEstacionBtn { border-radius:8px;padding:8px 12px;font-weight:600;box-shadow:0 4px 18px rgba(17,24,39,0.06) }
  .cell-inner.drop-target{outline:2px dashed var(--primary);}
  @media (max-width:900px){ .controls{ flex-direction:column; align-items:flex-start; gap:8px } }
</style>
</head>
<body>
<header class="app-header">
  <div class="branding">
    <div class="logo">RM</div>
    <div>
      <h1>Rueda de Menú</h1>
      <p class="lead">Editar menús semanales — arrastra filas desde la izquierda, mueve platos entre celdas</p>
    </div>
  </div>
  <div class="controls">
    <div class="select">
      <label style="font-size:13px;color:var(--muted);margin-right:6px">Hotel</label>
      <select id="hotelSelector"><option value="Hotel1">Hotel1</option><option value="Hotel2">Hotel2</option></select>
    </div>
    <div class="select">
      <label style="font-size:13px;color:var(--muted);margin-right:6px">Rueda</label>
      <select id="ruedaSelector"><option value="2026_desayuno">2026_desayuno</option><option value="2026_almuerzo">2026_almuerzo</option><option value="2026_cena">2026_cena</option></select>
    </div>
    <button id="addEstacionBtn" class="btn ghost">Añadir estación</button>
    <button id="copiarPlatos" class="btn">Copiar platos</button>
    <button id="pegarPlatos" class="btn ghost">Pegar contenido</button>
  </div>
</header>

<main class="layout">
  <div id="tabla"></div>
</main>

<script src="https://unpkg.com/tabulator-tables@5.5.0/dist/js/tabulator.min.js"></script>
<script>
// ---------------- datos base ----------------
const sampleData = {
  "Hotel1|2026_desayuno":[
    { _id:1, estacion:"Frío", L:["Yogur","Fruta"], M:[], X:[], J:["Tostadas"], V:[], S:[], D:[] },
    { _id:2, estacion:"Caliente", L:["Huevos revueltos"], M:["Sopa"], X:[], J:[], V:[], S:[], D:[] },
    { _id:3, estacion:"Postres", L:["Croissant"], M:[], X:[], J:[], V:[], S:[], D:[] }
  ],
  "Hotel1|2026_almuerzo":[
    { _id:1, estacion:"Frío", L:[], M:["Ensalada"], X:[], J:[], V:["Gazpacho"], S:[], D:[] },
    { _id:2, estacion:"Caliente", L:["Pollo asado"], M:["Paella"], X:[], J:[], V:[], S:[], D:[] },
    { _id:3, estacion:"Postres", L:["Fruta"], M:[], X:[], J:[], V:[], S:[], D:[] }
  ],
  "Hotel1|2026_cena":[
    { _id:1, estacion:"Frío", L:[], M:[], X:[], J:["Ensalada Cesar"], V:[], S:[], D:[] },
    { _id:2, estacion:"Caliente", L:[], M:[], X:["Pescado"], J:[], V:[], S:[], D:[] },
    { _id:3, estacion:"Postres", L:[], M:[], X:[], J:[], V:["Helado"], S:[], D:[] }
  ]
};

// ---------------- estado global ----------------
let tabla, celdaEditando=null, modoCopia=false, modoSeleccionPlatos=false, platosSeleccionados=[];

function ensureArr(v){return Array.isArray(v)?v:(v?[v]:[]);}

// ---------------- renderer platos ----------------
function renderPlatos(cell){
  const val=ensureArr(cell.getValue());
  const cont=document.createElement("div");
  cont.className="cell-inner"+(val.length===0?" empty":"");
  cont.style.minHeight=(val.length*34+48)+"px"; // altura = platos + botón +

  // botón +
  const addBtn=document.createElement("button");
  addBtn.className="add-plato"; addBtn.textContent="+"; addBtn.title="Añadir plato";
  addBtn.addEventListener("click",(e)=>{e.stopPropagation(); celdaEditando=cell; mostrarBuscador(cell);});
  cont.appendChild(addBtn);

  const el=cell.getElement();
  if(!el._dropBound){
    el.addEventListener("dragover",(e)=>{e.preventDefault(); el.classList.add("drop-target");});
    el.addEventListener("dragleave",()=>el.classList.remove("drop-target"));
    el.addEventListener("drop",(e)=>{
      e.preventDefault(); el.classList.remove("drop-target");
      const data=JSON.parse(e.dataTransfer.getData("application/json")||"{}"); if(!data.plato) return;
      const dest=ensureArr(cell.getValue()); if(!dest.includes(data.plato)) dest.push(data.plato); cell.setValue(dest);
      // eliminar del origen
      const origin = tabla.getRows().find(r=>r.getData()._id===data.rowId);
      if(origin){const ocell=origin.getCell(data.field); if(ocell && !(ocell===cell)){const oVal=ensureArr(ocell.getValue()).filter(p=>p!==data.plato); ocell.setValue(oVal);}}
      tabla.redraw(true);
    });
    el._dropBound=true;
  }

  val.forEach(plato=>{
    const row=document.createElement("div"); row.className="plato-row";
    if(modoSeleccionPlatos){ const cb=document.createElement("input"); cb.type="checkbox";
      cb.addEventListener("change",()=>{ if(cb.checked) platosSeleccionados.push({plato,rowId:cell.getRow().getData()._id,field:cell.getField()}); else platosSeleccionados=platosSeleccionados.filter(p=>!(p.plato===plato && p.rowId===cell.getRow().getData()._id && p.field===cell.getField())); });
      row.appendChild(cb);
    }
    row.appendChild(document.createTextNode(plato));
    const rm=document.createElement("button"); rm.className="remove"; rm.textContent="×";
    rm.addEventListener("click",(e)=>{ e.stopPropagation(); const nuevo=ensureArr(cell.getValue()).filter(p=>p!==plato); cell.setValue(nuevo); tabla.redraw(true); });
    row.appendChild(rm);

    // drag solo para platos
    row.draggable=true;
    row.addEventListener("dragstart",(e)=>{ e.dataTransfer.setData("application/json",JSON.stringify({plato,rowId:cell.getRow().getData()._id,field:cell.getField()})); e.dataTransfer.effectAllowed="move"; });
    cont.appendChild(row);
  });

  if(modoCopia){ const cb=document.createElement("input"); cb.type="checkbox"; cb.className="cell-select"; cb.addEventListener("change",(e)=>{cell.selectedParaPegar=cb.checked;}); cont.appendChild(cb); }

  return cont;
}

function mostrarBuscador(cell){ const nombre=prompt("Añadir plato:"); if(!nombre) return; const arr=ensureArr(cell.getValue()); if(!arr.includes(nombre)) arr.push(nombre); cell.setValue(arr); tabla.redraw(true);}

// ---------------- inicializar tabla ----------------
tabla=new Tabulator("#tabla",{
  data: sampleData["Hotel1|2026_desayuno"],
  layout:"fitColumns",
  reactiveData:true,
  movableRows:true,
  movableRowsHandle:".handle-icon",
  columns:[
    {title:"Estación",field:"estacion",width:160,hozAlign:"left",headerSort:false,formatter:(cell)=>{ const el=document.createElement("div"); el.className="handle-cell"; const h=document.createElement("span"); h.className="handle-icon"; h.innerText="≡"; const t=document.createElement("span"); t.style.flex="1"; t.style.fontWeight="600"; t.innerText=cell.getValue(); el.appendChild(h); el.appendChild(t); return el; }, frozen:true},
    {title:"L",field:"L",formatter:renderPlatos},
    {title:"M",field:"M",formatter:renderPlatos},
    {title:"X",field:"X",formatter:renderPlatos},
    {title:"J",field:"J",formatter:renderPlatos},
    {title:"V",field:"V",formatter:renderPlatos},
    {title:"S",field:"S",formatter:renderPlatos},
    {title:"D",field:"D",formatter:renderPlatos},
  ]
});

// ---------------- botones ----------------
const copiarBtn=document.getElementById("copiarPlatos");
const pegarBtn=document.getElementById("pegarPlatos");
const addEstBtn=document.getElementById("addEstacionBtn");
const hotelSel=document.getElementById("hotelSelector");
const ruedaSel=document.getElementById("ruedaSelector");

copiarBtn.addEventListener("click",()=>{
  if(!modoSeleccionPlatos && !modoCopia){ modoSeleccionPlatos=true; platosSeleccionados=[]; copiarBtn.textContent="Confirmar selección"; tabla.redraw(true); return; }
  if(modoSeleccionPlatos){ modoSeleccionPlatos=false; modoCopia=platosSeleccionados.length>0; copiarBtn.textContent="Copiar celdas"; tabla.redraw(true); return; }
  if(modoCopia){ modoCopia=false; platosSeleccionados=[]; copiarBtn.textContent="Copiar platos"; tabla.redraw(true); return; }
});

pegarBtn.addEventListener("click",()=>{
  if(platosSeleccionados.length===0){ modoCopia=false; tabla.redraw(true); return; }
  tabla.getRows().forEach(r=>{ Object.keys(r.getData()).forEach(f=>{ if(f==="estacion") return; const c=r.getCell(f); if(c && c.selectedParaPegar){ const dest=ensureArr(c.getValue()); platosSeleccionados.forEach(p=>{if(!dest.includes(p.plato)) dest.push(p.plato);}); c.setValue(dest); } }); });
  modoCopia=false; platosSeleccionados=[]; tabla.redraw(true);
});

// añadir estación
addEstBtn.addEventListener("click",()=>{ const nombre=prompt("Nombre de la estación:"); if(!nombre) return; const newRow={_id:Date.now(),estacion:nombre,L:[],M:[],X:[],J:[],V:[],S:[],D:[]}; tabla.addRow(newRow,true).then(row=>row.getElement().scrollIntoView({behavior:"smooth",block:"center"})); });

// cargar datos
function loadCombination(){ const key=`${hotelSel.value}|${ruedaSel.value}`; const dataset=sampleData[key]||[{_id:1,estacion:"Frío",L:[],M:[],X:[],J:[],V:[],S:[],D:[]},{_id:2,estacion:"Caliente",L:[],M:[],X:[],J:[],V:[],S:[],D:[]}]; modoCopia=false; modoSeleccionPlatos=false; platosSeleccionados=[]; copiarBtn.textContent="Copiar platos"; tabla.setData(dataset);}
hotelSel.addEventListener("change",loadCombination);
ruedaSel.addEventListener("change",loadCombination);
</script>
</body>
</html>
